<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>เข้าสู่ระบบ / ลงทะเบียน | โรงเรียนอุบลบุรีรักษ์การบริบาล</title>
  <style>
    body {
      margin:0;
      font-family:Arial,sans-serif;
      background:#f3f4f6;
    }
    header {
      background:linear-gradient(120deg,#ff6fb5,#0d6efd,#20c997);
      color:white;
      padding:14px 16px;
      box-shadow:0 2px 10px rgba(0,0,0,0.18);
    }
    .header-main {
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
    }
    .header-main img {
      width:44px;
      height:44px;
      border-radius:50%;
      background:white;
      padding:4px;
      box-shadow:0 2px 6px rgba(0,0,0,0.25);
    }
    .header-main h1 {
      margin:0;
      font-size:20px;
    }
    .header-main p {
      margin:0;
      font-size:12px;
    }
    nav {
      margin-top:8px;
      display:flex;
      flex-wrap:wrap;
      gap:6px;
    }
    nav a {
      color:white;
      text-decoration:none;
      background:rgba(255,255,255,0.18);
      border-radius:999px;
      padding:4px 10px;
      font-size:12px;
      border:1px solid rgba(255,255,255,0.3);
    }
    nav a:hover {
      background:white;
      color:#ff2f92;
    }

    main {
      max-width:900px;
      margin:24px auto 40px;
      padding:0 12px;
    }

    .card {
      background:white;
      border-radius:18px;
      padding:18px 18px 22px;
      box-shadow:0 4px 16px rgba(15,23,42,0.08);
    }

    .tabs {
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      margin-bottom:12px;
    }
    .tab-btn {
      padding:6px 12px;
      border-radius:999px;
      border:1px solid #d1d5db;
      background:#f9fafb;
      font-size:13px;
      cursor:pointer;
    }
    .tab-btn.active {
      background:#0d6efd;
      color:white;
      border-color:#0d6efd;
      font-weight:bold;
    }

    h2 {
      margin:4px 0 12px;
      font-size:20px;
    }

    .msg {
      font-size:13px;
      margin-bottom:10px;
    }
    .msg.info { color:#4b5563; }
    .msg.error { color:#b91c1c; font-weight:bold; }
    .msg.success { color:#047857; font-weight:bold; }

    form {
      font-size:13px;
    }
    label {
      display:block;
      margin-top:8px;
      margin-bottom:2px;
    }
    input, select {
      width:100%;
      padding:7px 9px;
      border-radius:8px;
      border:1px solid #d1d5db;
      font-size:13px;
      box-sizing:border-box;
    }

    .row-2 {
      display:flex;
      gap:10px;
      flex-wrap:wrap;
    }
    .row-2 > div {
      flex:1 1 160px;
    }

    .btn-main {
      margin-top:12px;
      padding:9px 16px;
      border-radius:999px;
      border:none;
      background:#0d6efd;
      color:white;
      font-size:13px;
      cursor:pointer;
    }
    .btn-main:hover {
      background:#0b57d0;
    }
    .small-note {
      font-size:12px;
      color:#6b7280;
      margin-top:6px;
    }

    .hidden {
      display:none;
    }

    footer {
      text-align:center;
      padding:10px;
      background:#111827;
      color:white;
      font-size:12px;
    }
  </style>
</head>
<body>
<header>
  <div class="header-main">
    <img src="https://www.urrschool.com/favicon.ico" alt="โลโก้ URR">
    <div>
      <h1>เข้าสู่ระบบ / ลงทะเบียนสมาชิก</h1>
      <p>โรงเรียนอุบลบุรีรักษ์การบริบาล | URR School</p>
    </div>
  </div>
  <nav>
    <a href="index.html">หน้าแรก</a>
    <a href="courses.html">หลักสูตร</a>
    <a href="online-learning.html">เรียนออนไลน์</a>
    <a href="admin.html">Admin</a>
  </nav>
</header>

<main>
  <div class="card">
    <div class="tabs">
      <button class="tab-btn active" data-tab="login">เข้าสู่ระบบ</button>
      <button class="tab-btn" data-tab="register">ลงทะเบียนสมาชิกใหม่</button>
      <button class="tab-btn" data-tab="forgot">ลืมรหัสผ่าน</button>
    </div>

    <div id="globalMsg" class="msg info">กรุณาเลือกทำรายการ: เข้าสู่ระบบ / ลงทะเบียน / ลืมรหัสผ่าน</div>

    <!-- เข้าสู่ระบบ -->
    <section id="tab-login">
      <h2>เข้าสู่ระบบสำหรับสมาชิกที่มีบัญชีแล้ว</h2>
      <form id="loginForm">
        <label for="loginEmail">อีเมล</label>
        <input type="email" id="loginEmail" required placeholder="กรอกอีเมลที่ใช้สมัคร">

        <label for="loginPassword">รหัสผ่าน</label>
        <input type="password" id="loginPassword" required placeholder="รหัสผ่านอย่างน้อย 8 ตัวอักษร">

        <button type="submit" class="btn-main" id="btnLogin">เข้าสู่ระบบ</button>
        <div class="small-note">
          ยังไม่เป็นสมาชิก? เลือกแท็บ "<strong>ลงทะเบียนสมาชิกใหม่</strong>" ด้านบนก่อน
        </div>
      </form>
    </section>

    <!-- ลงทะเบียน -->
    <section id="tab-register" class="hidden">
      <h2>ลงทะเบียนสมาชิกใหม่</h2>
      <form id="registerForm">
        <div class="row-2">
          <div>
            <label for="regFirstName">ชื่อ</label>
            <input type="text" id="regFirstName" required placeholder="เช่น นางสาวสุชาดา">
          </div>
          <div>
            <label for="regLastName">นามสกุล</label>
            <input type="text" id="regLastName" required placeholder="เช่น ใจดี">
          </div>
        </div>

        <label for="regEmail">อีเมล (ใช้สำหรับเข้าสู่ระบบ)</label>
        <input type="email" id="regEmail" required placeholder="กรอกอีเมลที่ใช้งานได้จริง">

        <div class="row-2">
          <div>
            <label for="regPhone">เบอร์โทรศัพท์</label>
            <input type="tel" id="regPhone" required placeholder="เช่น 080-1234567">
          </div>
          <div>
            <label for="regCitizenId">เลขบัตรประชาชน</label>
            <input type="text" id="regCitizenId" required placeholder="เลขบัตร 13 หลัก">
          </div>
        </div>

        <div class="row-2">
          <div>
            <label for="regPassword">รหัสผ่าน</label>
            <input type="password" id="regPassword" required placeholder="อย่างน้อย 8 ตัวอักษร">
          </div>
          <div>
            <label for="regPassword2">ยืนยันรหัสผ่าน</label>
            <input type="password" id="regPassword2" required placeholder="กรอกรหัสผ่านซ้ำอีกครั้ง">
          </div>
        </div>

        <button type="submit" class="btn-main" id="btnRegister">ลงทะเบียน</button>
        <div class="small-note">
          หลังลงทะเบียนแล้ว สถานะของคุณจะเป็น <strong>รออนุมัติ (pending)</strong><br>
          ผู้บริหารจะตรวจสอบและอนุมัติในภายหลัง จึงจะเข้าเรียนออนไลน์และระบบอื่น ๆ ได้
        </div>
      </form>
    </section>

    <!-- ลืมรหัสผ่าน -->
    <section id="tab-forgot" class="hidden">
      <h2>ลืมรหัสผ่าน</h2>
      <form id="forgotForm">
        <label for="forgotEmail">อีเมลที่ใช้สมัคร</label>
        <input type="email" id="forgotEmail" required placeholder="กรอกอีเมลที่ใช้ลงทะเบียน">

        <button type="submit" class="btn-main" id="btnForgot">ส่งลิงก์สำหรับตั้งรหัสผ่านใหม่</button>
        <div class="small-note">
          ระบบจะส่งอีเมลจาก Firebase เพื่อให้คุณตั้งรหัสผ่านใหม่
        </div>
      </form>
    </section>
  </div>
</main>

<footer>
  © 2025 โรงเรียนอุบลบุรีรักษ์การบริบาล | ระบบสมาชิกเชื่อมต่อ Firebase Auth + Firestore
</footer>

<script type="module">
  // ================= Firebase Setup =================
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
  import {
    getAuth,
    createUserWithEmailAndPassword,
    signInWithEmailAndPassword,
    sendPasswordResetEmail,
    onAuthStateChanged
  } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
  import {
    getFirestore,
    doc,
    setDoc,
    serverTimestamp
  } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBhlCI3LfdCnOJzrTbK59nxL-77VyF9Mm0",
    authDomain: "urrschool-system.firebaseapp.com",
    projectId: "urrschool-system",
    storageBucket: "urrschool-system.firebasestorage.app",
    messagingSenderId: "183740550258",
    appId: "1:183740550258:web:674b73d1843553574fc6eb",
    measurementId: "G-GHLCDECTDF"
  };

  const app  = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db   = getFirestore(app);

  // ================= DOM helper =================
  const globalMsg      = document.getElementById("globalMsg");
  const tabButtons     = document.querySelectorAll(".tab-btn");
  const tabLogin       = document.getElementById("tab-login");
  const tabRegister    = document.getElementById("tab-register");
  const tabForgot      = document.getElementById("tab-forgot");

  const loginForm      = document.getElementById("loginForm");
  const registerForm   = document.getElementById("registerForm");
  const forgotForm     = document.getElementById("forgotForm");

  const loginEmail     = document.getElementById("loginEmail");
  const loginPassword  = document.getElementById("loginPassword");
  const btnLogin       = document.getElementById("btnLogin");

  const regFirstName   = document.getElementById("regFirstName");
  const regLastName    = document.getElementById("regLastName");
  const regEmail       = document.getElementById("regEmail");
  const regPhone       = document.getElementById("regPhone");
  const regCitizenId   = document.getElementById("regCitizenId");
  const regPassword    = document.getElementById("regPassword");
  const regPassword2   = document.getElementById("regPassword2");
  const btnRegister    = document.getElementById("btnRegister");

  const forgotEmail    = document.getElementById("forgotEmail");
  const btnForgot      = document.getElementById("btnForgot");

  function setGlobalMsg(text, type="info") {
    globalMsg.textContent = text;
    globalMsg.className = "msg " + type;
  }

  // ================= Tab Switching =================
  function showTab(name) {
    tabLogin.classList.add("hidden");
    tabRegister.classList.add("hidden");
    tabForgot.classList.add("hidden");

    if (name === "login") tabLogin.classList.remove("hidden");
    if (name === "register") tabRegister.classList.remove("hidden");
    if (name === "forgot") tabForgot.classList.remove("hidden");

    tabButtons.forEach(btn => {
      btn.classList.toggle("active", btn.dataset.tab === name);
    });

    // อัปเดต hash ใน URL ให้อิงกับปุ่ม
    if (name === "login")   window.location.hash = "#login";
    if (name === "register")window.location.hash = "#register";
    if (name === "forgot")  window.location.hash = "#forgot";
  }

  tabButtons.forEach(btn => {
    btn.addEventListener("click", () => {
      const tab = btn.dataset.tab;
      showTab(tab);
      if (tab === "login") {
        setGlobalMsg("กรุณากรอกอีเมลและรหัสผ่านเพื่อเข้าสู่ระบบ", "info");
      } else if (tab === "register") {
        setGlobalMsg("กรอกข้อมูลให้ครบถ้วนเพื่อสมัครสมาชิกใหม่", "info");
      } else {
        setGlobalMsg("กรอกอีเมลที่ใช้สมัคร เพื่อรับลิงก์ตั้งรหัสผ่านใหม่", "info");
      }
    });
  });

  // เปิดแท็บตาม hash ใน URL
  function initTabFromHash() {
    const hash = window.location.hash || "#login";
    if (hash === "#register") {
      showTab("register");
      setGlobalMsg("กรอกข้อมูลเพื่อสมัครสมาชิกใหม่", "info");
    } else if (hash === "#forgot") {
      showTab("forgot");
      setGlobalMsg("กรอกอีเมลเพื่อรับลิงก์ตั้งรหัสผ่านใหม่", "info");
    } else {
      showTab("login");
      setGlobalMsg("กรุณากรอกอีเมลและรหัสผ่านเพื่อเข้าสู่ระบบ", "info");
    }
  }

  // ================= Register Flow =================
  registerForm.addEventListener("submit", async (e) => {
    e.preventDefault();

    const firstName = regFirstName.value.trim();
    const lastName  = regLastName.value.trim();
    const email     = regEmail.value.trim();
    const phone     = regPhone.value.trim();
    const citizenId = regCitizenId.value.trim();
    const pw        = regPassword.value;
    const pw2       = regPassword2.value;

    if (!firstName || !lastName || !email || !phone || !citizenId || !pw || !pw2) {
      setGlobalMsg("กรุณากรอกข้อมูลให้ครบทุกช่อง", "error");
      return;
    }
    if (pw.length < 8) {
      setGlobalMsg("รหัสผ่านต้องมีความยาวอย่างน้อย 8 ตัวอักษร", "error");
      return;
    }
    if (pw !== pw2) {
      setGlobalMsg("รหัสผ่านและยืนยันรหัสผ่านไม่ตรงกัน", "error");
      return;
    }

    btnRegister.disabled = true;
    setGlobalMsg("กำลังลงทะเบียนสมาชิกใหม่...", "info");

    try {
      const cred = await createUserWithEmailAndPassword(auth, email, pw);
      const uid = cred.user.uid;

      await setDoc(doc(db, "members", uid), {
        firstName,
        lastName,
        email,
        phone,
        citizenId,
        status: "pending",     // รออนุมัติ
        role: "user",
        createdAt: serverTimestamp()
      });

      setGlobalMsg("ลงทะเบียนสำเร็จ! สถานะของคุณคือ 'รออนุมัติ (pending)' กรุณารอผู้ดูแลระบบอนุมัติแล้วจึงเข้าเรียนออนไลน์ได้", "success");
      registerForm.reset();
      showTab("login");
    } catch (err) {
      console.error(err);
      let msg = "ไม่สามารถลงทะเบียนได้";
      if (err.code === "auth/email-already-in-use") {
        msg = "อีเมลนี้ถูกใช้ลงทะเบียนแล้ว กรุณาใช้เมลอื่น หรือเข้าสู่ระบบ";
      }
      setGlobalMsg(msg, "error");
    } finally {
      btnRegister.disabled = false;
    }
  });

  // ================= Login Flow =================
  loginForm.addEventListener("submit", async (e) => {
    e.preventDefault();

    const email = loginEmail.value.trim();
    const pw    = loginPassword.value;

    if (!email || !pw) {
      setGlobalMsg("กรุณากรอกอีเมลและรหัสผ่านให้ครบ", "error");
      return;
    }
    if (pw.length < 8) {
      setGlobalMsg("รหัสผ่านต้องมีความยาวอย่างน้อย 8 ตัวอักษร", "error");
      return;
    }

    btnLogin.disabled = true;
    setGlobalMsg("กำลังเข้าสู่ระบบ...", "info");

    try {
      await signInWithEmailAndPassword(auth, email, pw);
      setGlobalMsg("เข้าสู่ระบบสำเร็จ กำลังนำคุณไปยังระบบเรียนออนไลน์...", "success");
      setTimeout(() => {
        window.location.href = "online-learning.html";
      }, 800);
    } catch (err) {
      console.error(err);
      let msg = "เข้าสู่ระบบไม่สำเร็จ กรุณาตรวจสอบอีเมล/รหัสผ่าน";
      if (err.code === "auth/user-not-found") {
        msg = "ไม่พบบัญชีผู้ใช้ในระบบ กรุณาลงทะเบียนสมาชิกใหม่ก่อน";
      } else if (err.code === "auth/wrong-password") {
        msg = "รหัสผ่านไม่ถูกต้อง กรุณาลองใหม่ หรือใช้เมนู 'ลืมรหัสผ่าน'";
      }
      setGlobalMsg(msg, "error");
    } finally {
      btnLogin.disabled = false;
    }
  });

  // ================= Forgot Password Flow =================
  forgotForm.addEventListener("submit", async (e) => {
    e.preventDefault();
    const email = forgotEmail.value.trim();
    if (!email) {
      setGlobalMsg("กรุณากรอกอีเมลที่ใช้สมัคร", "error");
      return;
    }

    btnForgot.disabled = true;
    setGlobalMsg("กำลังส่งอีเมลสำหรับตั้งรหัสผ่านใหม่...", "info");

    try {
      await sendPasswordResetEmail(auth, email);
      setGlobalMsg("ส่งลิงก์ตั้งรหัสผ่านใหม่ไปที่อีเมลแล้ว กรุณาตรวจสอบกล่องจดหมาย/สแปม", "success");
      forgotForm.reset();
    } catch (err) {
      console.error(err);
      let msg = "ไม่สามารถส่งอีเมลสำหรับตั้งรหัสผ่านใหม่ได้";
      if (err.code === "auth/user-not-found") {
        msg = "ไม่พบบัญชีผู้ใช้ที่ใช้อีเมลนี้ในระบบ";
      }
      setGlobalMsg(msg, "error");
    } finally {
      btnForgot.disabled = false;
    }
  });

  // ================= Check if already logged in =================
  onAuthStateChanged(auth, (user) => {
    // ถ้าต้องการให้ auto-redirect เมื่อเคยล็อกอินแล้ว สามารถใช้ส่วนนี้
    if (user) {
      // ยังให้ผู้ใช้กด login เองก็ได้ เลยไม่ redirect ทันที
      // setGlobalMsg("คุณล็อกอินอยู่แล้ว: " + (user.email || ""), "info");
    }
  });

  // init แท็บตาม hash
  initTabFromHash();
</script>

</body>
</html>

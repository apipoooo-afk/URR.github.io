<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>เข้าสู่ระบบ | โรงเรียนอุบลบุรีรักษ์การบริบาล</title>

  <style>
    :root {
      --pink: #ff6fb5;
      --blue: #0d6efd;
      --green: #20c997;
      --bg: #f9f5ff;
      --card: #ffffff;
    }
    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background:
        radial-gradient(circle at top left,#ffe0f3 0%,transparent 45%),
        radial-gradient(circle at top right,#e0f2ff 0%,transparent 50%),
        radial-gradient(circle at bottom,#e7fff4 0%,#f9fafb 60%);
      color:#212529;
    }

    header {
      background: linear-gradient(120deg,#ff6fb5,#0d6efd,#20c997);
      color:white;
      padding:10px 14px 12px;
      box-shadow:0 2px 10px rgba(0,0,0,0.18);
    }
    .header-main {
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
    }
    .logo {
      width:48px;
      height:48px;
      border-radius:50%;
      background:white;
      padding:4px;
      box-shadow:0 2px 6px rgba(0,0,0,0.25);
      object-fit:contain;
    }
    .header-text h1 {
      margin:0;
      font-size:22px;
    }
    .header-text p {
      margin:0;
      font-size:13px;
      opacity:0.95;
    }

    nav {
      margin-top:8px;
      display:flex;
      flex-wrap:wrap;
      gap:6px;
    }
    nav a {
      color:white;
      text-decoration:none;
      background:rgba(255,255,255,0.16);
      border-radius:999px;
      padding:4px 10px;
      font-size:12px;
      border:1px solid rgba(255,255,255,0.3);
    }
    nav a:hover {
      background:white;
      color:#ff2f92;
    }

    main {
      max-width: 800px;
      margin: 26px auto 40px;
      padding: 0 12px;
    }

    .card {
      background:var(--card);
      border-radius:18px;
      padding:18px 18px 20px;
      box-shadow:0 4px 14px rgba(15,23,42,0.08);
    }

    h2 {
      margin-top:0;
      text-align:center;
      font-size:20px;
      color:#333;
    }
    p.sub {
      text-align:center;
      font-size:13px;
      color:#555;
      margin-top:4px;
      margin-bottom:14px;
    }

    .form-group {
      margin-bottom:12px;
    }
    label {
      display:block;
      font-weight:bold;
      margin-bottom:4px;
      font-size:13px;
    }
    input[type="text"],
    input[type="password"] {
      width:100%;
      padding:9px 11px;
      border-radius:8px;
      border:1px solid #d0d7e2;
      font-size:13px;
    }

    .btn-main {
      width:100%;
      padding:10px;
      border:none;
      border-radius:999px;
      font-size:14px;
      cursor:pointer;
      background:linear-gradient(135deg,#20c997,#0d6efd);
      color:white;
      font-weight:bold;
      box-shadow:0 4px 12px rgba(32,201,151,0.45);
      margin-top:6px;
    }
    .btn-main:hover { transform:translateY(-1px); }

    .note {
      font-size:11px;
      color:#666;
      margin-top:3px;
    }

    .msg {
      font-size:12px;
      margin-top:6px;
    }
    .msg.error {
      color:#c1121f;
      font-weight:bold;
    }
    .msg.success {
      color:#0f766e;
      font-weight:bold;
    }

    .link-row {
      margin-top:10px;
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      justify-content:space-between;
      font-size:12px;
    }
    .link-small {
      color:#0d6efd;
      text-decoration:none;
    }
    .link-small:hover { text-decoration:underline; }

    .current-user-box {
      margin-top:14px;
      padding:10px;
      border-radius:10px;
      background:#ecfdf3;
      border:1px solid #bbf7d0;
      font-size:12px;
      display:none;
    }

    footer {
      text-align:center;
      padding:12px;
      background:#343a40;
      color:white;
      font-size:12px;
    }
  </style>
</head>
<body>

<header>
  <div class="header-main">
    <img src="https://www.urrschool.com/favicon.ico" alt="โลโก้โรงเรียน" class="logo">
    <div class="header-text">
      <h1>โรงเรียนอุบลบุรีรักษ์การบริบาล</h1>
      <p>ระบบสมาชิก | เข้าสู่ระบบเพื่อใช้งานระบบออนไลน์ทั้งหมด</p>
    </div>
  </div>
  <nav>
    <a href="index.html">หน้าแรก</a>
    <a href="register.html">ลงทะเบียนสมาชิกใหม่</a>
    <a href="courses.html">หลักสูตร</a>
    <a href="dashboard.html">ฐานข้อมูล (Admin)</a>
  </nav>
</header>

<main>
  <div class="card">
    <h2>เข้าสู่ระบบสมาชิก</h2>
    <p class="sub">
      ใช้ <strong>อีเมล</strong> หรือ <strong>เลขบัตรประชาชน</strong> ร่วมกับรหัสผ่านที่ได้ลงทะเบียนไว้<br>
      บัญชีต้องได้รับการ <strong>อนุมัติ (approved)</strong> จากผู้ดูแลก่อนจึงจะเข้าใช้งานระบบได้
    </p>

    <div id="loginMsg" class="msg"></div>

    <form id="loginForm">
      <div class="form-group">
        <label for="loginId">อีเมล หรือเลขบัตรประชาชน</label>
        <input type="text" id="loginId" required>
      </div>

      <div class="form-group">
        <label for="loginPassword">รหัสผ่าน</label>
        <input type="password" id="loginPassword" required>
        <div class="note">รหัสผ่านต้องไม่น้อยกว่า 8 ตัวอักษร</div>
      </div>

      <button type="submit" class="btn-main">เข้าสู่ระบบ</button>
    </form>

    <div class="link-row">
      <a href="register.html" class="link-small">ยังไม่มีบัญชี? ลงทะเบียนสมาชิกใหม่</a>
      <a href="forgot.html" class="link-small">ลืมรหัสผ่าน</a>
    </div>

    <div id="currentUserBox" class="current-user-box">
      <div><strong>สถานะ:</strong> <span id="cuStatusText"></span></div>
      <div><strong>ชื่อ:</strong> <span id="cuNameText"></span></div>
      <div><strong>อีเมล:</strong> <span id="cuEmailText"></span></div>
      <div><strong>บทบาท:</strong> <span id="cuRoleText"></span></div>
      <button id="btnLogout" class="btn-main" style="margin-top:8px;padding:8px;font-size:13px;">
        ออกจากระบบ
      </button>
    </div>
  </div>
</main>

<footer>
  © 2025 โรงเรียนอุบลบุรีรักษ์การบริบาล | ระบบสมาชิกเชื่อมต่อ Firebase Auth + Firestore
</footer>

<!-- Login Logic เชื่อม Firebase -->
<script type="module">
  // ===== Firebase SDK =====
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
  import {
    getAuth,
    signInWithEmailAndPassword,
    signOut,
    onAuthStateChanged
  } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
  import {
    getFirestore,
    doc,
    getDoc,
    collection,
    query,
    where,
    getDocs
  } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

  // ===== Firebase Config (ตัวเดียวกับ register.html) =====
  const firebaseConfig = {
    apiKey: "AIzaSyBhlCI3LfdCnOJzrTbK59nxL-77VyF9Mm0",
    authDomain: "urrschool-system.firebaseapp.com",
    projectId: "urrschool-system",
    storageBucket: "urrschool-system.firebasestorage.app",
    messagingSenderId: "183740550258",
    appId: "1:183740550258:web:674b73d1843553574fc6eb",
    measurementId: "G-GHLCDECTDF"
  };

  const app  = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db   = getFirestore(app);

  console.log("✅ Firebase ready on login page");

  // ใช้เก็บข้อมูล current user ไว้ใน localStorage เผื่อหน้า index/dashboard ใช้ต่อ
  const CURRENT_USER_KEY = "urr_current_user";

  function showMsg(text, type = "") {
    const box = document.getElementById("loginMsg");
    if (!box) return;
    box.textContent = text;
    box.className = "msg " + (type === "error" ? "error" : type === "success" ? "success" : "");
  }

  function saveCurrentUser(profile) {
    try {
      localStorage.setItem(CURRENT_USER_KEY, JSON.stringify(profile || null));
    } catch (e) {
      console.warn("Cannot save current user to localStorage", e);
    }
  }

  function clearCurrentUser() {
    try {
      localStorage.removeItem(CURRENT_USER_KEY);
    } catch (e) {
      console.warn("Cannot clear current user", e);
    }
  }

  function updateCurrentUserBox(profile) {
    const box  = document.getElementById("currentUserBox");
    const stEl = document.getElementById("cuStatusText");
    const nmEl = document.getElementById("cuNameText");
    const emEl = document.getElementById("cuEmailText");
    const rlEl = document.getElementById("cuRoleText");

    if (!box) return;

    if (!profile) {
      box.style.display = "none";
      return;
    }

    box.style.display = "block";
    if (stEl) stEl.textContent = profile.status || "-";
    if (nmEl) nmEl.textContent = (profile.firstName || "") + " " + (profile.lastName || "");
    if (emEl) emEl.textContent = profile.email || "-";
    if (rlEl) rlEl.textContent = profile.role || "user";
  }

  async function findEmailFromCitizenId(citizenId) {
    const qRef = query(
      collection(db, "members"),
      where("citizenId", "==", citizenId)
    );
    const snap = await getDocs(qRef);
    if (snap.empty) return null;
    const docData = snap.docs[0].data();
    return docData.email || null;
  }

  async function fetchMemberProfile(uid) {
    const d = await getDoc(doc(db, "members", uid));
    if (!d.exists()) return null;
    return d.data();
  }

  function redirectByRole(role) {
    // ถ้าเป็น admin → ไป dashboard, ถ้าไม่ใช่ → index
    if (role === "admin" || role === "superadmin") {
      window.location.href = "dashboard.html";
    } else {
      window.location.href = "index.html";
    }
  }

  // ===== EVENT: DOM Ready =====
  document.addEventListener("DOMContentLoaded", () => {
    const form      = document.getElementById("loginForm");
    const btnLogout = document.getElementById("btnLogout");

    // handle login form submit
    if (form) {
      form.addEventListener("submit", async (e) => {
        e.preventDefault();
        showMsg("");

        const loginId = document.getElementById("loginId").value.trim();
        const pw      = document.getElementById("loginPassword").value;

        if (!loginId || !pw) {
          showMsg("กรุณากรอกข้อมูลให้ครบถ้วน", "error");
          return;
        }
        if (pw.length < 8) {
          showMsg("รหัสผ่านต้องไม่น้อยกว่า 8 ตัวอักษร", "error");
          return;
        }

        try {
          showMsg("กำลังเข้าสู่ระบบ... กรุณารอสักครู่");

          // 1) แปลง citizenId → email ถ้าไม่มี @
          let emailToUse = loginId;
          if (!loginId.includes("@")) {
            const emailFromCid = await findEmailFromCitizenId(loginId);
            if (!emailFromCid) {
              showMsg("ไม่พบบัญชีผู้ใช้จากเลขบัตรประชาชนนี้", "error");
              return;
            }
            emailToUse = emailFromCid;
          }

          // 2) เรียก Firebase Auth signIn
          const cred = await signInWithEmailAndPassword(auth, emailToUse, pw);
          const user = cred.user;

          // 3) ดึงข้อมูลโปรไฟล์จาก Firestore
          const profile = await fetchMemberProfile(user.uid);
          if (!profile) {
            showMsg("เข้าสู่ระบบได้ แต่ไม่พบข้อมูลสมาชิกในฐานข้อมูล Firestore", "error");
            await signOut(auth);
            clearCurrentUser();
            return;
          }

          // 4) เช็คสถานะ
          if (profile.status !== "approved") {
            showMsg(
              "บัญชีของคุณยังไม่ได้รับการอนุมัติจากผู้ดูแล (สถานะ: " +
              (profile.status || "ไม่ทราบ") + ")",
              "error"
            );
            await signOut(auth);
            clearCurrentUser();
            return;
          }

          const fullProfile = {
            uid: user.uid,
            email: profile.email || user.email || "",
            firstName: profile.firstName || "",
            lastName: profile.lastName || "",
            role: profile.role || "user",
            status: profile.status || "approved"
          };

          saveCurrentUser(fullProfile);
          updateCurrentUserBox(fullProfile);
          showMsg("เข้าสู่ระบบสำเร็จ กำลังนำคุณเข้าสู่ระบบ...", "success");

          setTimeout(() => {
            redirectByRole(fullProfile.role);
          }, 800);

        } catch (err) {
          console.error(err);
          let msg = "ไม่สามารถเข้าสู่ระบบได้";

          if (err.code === "auth/user-not-found") {
            msg = "ไม่พบบัญชีผู้ใช้นี้ในระบบ";
          } else if (err.code === "auth/wrong-password") {
            msg = "รหัสผ่านไม่ถูกต้อง";
          } else if (err.code === "auth/invalid-email") {
            msg = "รูปแบบอีเมลไม่ถูกต้อง";
          } else if (err.code === "auth/too-many-requests") {
            msg = "พยายามเข้าสู่ระบบหลายครั้งเกินไป กรุณาลองใหม่ภายหลัง";
          }

          showMsg(msg, "error");
          clearCurrentUser();
        }
      });
    }

    // handle logout button
    if (btnLogout) {
      btnLogout.addEventListener("click", async () => {
        if (!confirm("ต้องการออกจากระบบหรือไม่?")) return;
        try {
          await signOut(auth);
        } catch (e) {
          console.warn("Error signOut:", e);
        }
        clearCurrentUser();
        updateCurrentUserBox(null);
        showMsg("ออกจากระบบเรียบร้อยแล้ว", "success");
      });
    }

    // ติดตามสถานะ Firebase Auth (ถ้าเคย login อยู่แล้ว)
    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        clearCurrentUser();
        updateCurrentUserBox(null);
        return;
      }
      try {
        const profile = await fetchMemberProfile(user.uid);
        if (!profile) {
          updateCurrentUserBox({
            uid: user.uid,
            email: user.email || "",
            firstName: "",
            lastName: "",
            role: "user",
            status: "unknown"
          });
          return;
        }
        const fullProfile = {
          uid: user.uid,
          email: profile.email || user.email || "",
          firstName: profile.firstName || "",
          lastName: profile.lastName || "",
          role: profile.role || "user",
          status: profile.status || "pending"
        };
        saveCurrentUser(fullProfile);
        updateCurrentUserBox(fullProfile);
      } catch (e) {
        console.warn("Cannot load profile on auth state change", e);
      }
    });
  });
</script>

</body>
</html>

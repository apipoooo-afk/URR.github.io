<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ระบบเรียนออนไลน์ | โรงเรียนอุบลบุรีรักษ์การบริบาล</title>

  <style>
    :root {
      --pink: #ff6fb5;
      --blue: #0d6efd;
      --green: #20c997;
      --bg: #f9f5ff;
      --card: #ffffff;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background:
        radial-gradient(circle at top left,#ffe0f3 0%,transparent 45%),
        radial-gradient(circle at top right,#e0f2ff 0%,transparent 50%),
        radial-gradient(circle at bottom,#e7fff4 0%,#f9fafb 60%);
      color:#111827;
    }

    header {
      background: linear-gradient(120deg,#ff6fb5,#0d6efd,#20c997);
      color:white;
      padding:12px 14px 14px;
      box-shadow:0 2px 10px rgba(0,0,0,0.18);
    }
    .header-main {
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
    }
    .logo {
      width:48px;
      height:48px;
      border-radius:50%;
      background:white;
      padding:4px;
      box-shadow:0 2px 6px rgba(0,0,0,0.25);
      object-fit:contain;
    }
    .header-text h1 {
      margin:0;
      font-size:22px;
    }
    .header-text p {
      margin:0;
      font-size:13px;
      opacity:0.95;
    }

    nav {
      margin-top:8px;
      display:flex;
      flex-wrap:wrap;
      gap:6px;
    }
    nav a {
      color:white;
      text-decoration:none;
      background:rgba(255,255,255,0.16);
      border-radius:999px;
      padding:4px 10px;
      font-size:12px;
      border:1px solid rgba(255,255,255,0.3);
    }
    nav a:hover {
      background:white;
      color:#ff2f92;
    }

    main {
      max-width: 960px;
      margin: 24px auto 40px;
      padding: 0 12px;
    }

    h2 {
      margin-top:0;
      font-size:20px;
      text-align:left;
      color:#111827;
    }
    .sub {
      font-size:13px;
      color:#4b5563;
      margin-top:2px;
      margin-bottom:12px;
    }

    .card {
      background:var(--card);
      border-radius:18px;
      padding:16px 18px 18px;
      margin-bottom:18px;
      box-shadow:0 4px 14px rgba(15,23,42,0.08);
    }

    .badge {
      display:inline-block;
      padding:2px 8px;
      border-radius:999px;
      font-size:11px;
      background:#e5e7eb;
      color:#374151;
      margin-left:4px;
    }
    .badge-ok    { background:#dcfce7; color:#166534; }
    .badge-warn  { background:#fef3c7; color:#92400e; }
    .badge-error { background:#fee2e2; color:#b91c1c; }

    .status-row {
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      align-items:center;
      font-size:13px;
    }

    .form-row {
      display:flex;
      flex-wrap:wrap;
      gap:10px;
    }
    .form-group {
      flex:1 1 200px;
      margin-top:8px;
    }
    label {
      display:block;
      font-size:13px;
      font-weight:bold;
      margin-bottom:4px;
    }
    input[type="text"],
    input[type="password"] {
      width:100%;
      padding:8px 10px;
      border-radius:8px;
      border:1px solid #d1d5db;
      font-size:13px;
    }

    .btn-main {
      padding:9px 14px;
      border-radius:999px;
      border:none;
      font-size:13px;
      cursor:pointer;
      background:linear-gradient(135deg,#20c997,#0d6efd);
      color:white;
      font-weight:bold;
      box-shadow:0 3px 10px rgba(32,201,151,0.45);
    }
    .btn-main:hover {
      transform:translateY(-1px);
    }

    .btn-ghost {
      padding:7px 12px;
      border-radius:999px;
      border:1px dashed #9ca3af;
      background:#f9fafb;
      font-size:12px;
      cursor:pointer;
    }

    .msg {
      font-size:12px;
      margin-top:6px;
    }
    .msg.error {
      color:#b91c1c;
      font-weight:bold;
    }
    .msg.success {
      color:#15803d;
      font-weight:bold;
    }

    table {
      width:100%;
      border-collapse:collapse;
      margin-top:10px;
      font-size:13px;
      background:white;
    }
    th,td {
      border:1px solid #e5e7eb;
      padding:6px 8px;
      text-align:left;
    }
    th {
      background:#f3f4f6;
      font-weight:bold;
    }

    footer {
      text-align:center;
      padding:12px;
      background:#111827;
      color:white;
      font-size:12px;
    }

    @media (max-width:640px) {
      .form-row { flex-direction:column; }
    }
  </style>
</head>
<body>

<header>
  <div class="header-main">
    <img src="https://www.urrschool.com/favicon.ico" alt="โลโก้โรงเรียน" class="logo">
    <div class="header-text">
      <h1>ระบบเรียนออนไลน์</h1>
      <p>โรงเรียนอุบลบุรีรักษ์การบริบาล | ต้องเข้าสู่ระบบ 2 ชั้นก่อนเข้าเรียนได้</p>
    </div>
  </div>

  <nav>
    <a href="index.html">หน้าแรก</a>
    <a href="login.html">เข้าสู่ระบบหลัก</a>
    <a href="register.html">ลงทะเบียนสมาชิก</a>
    <a href="dashboard.html">ฐานข้อมูล (Admin)</a>
  </nav>
</header>

<main>

  <!-- ชั้นที่ 1: สถานะสมาชิก -->
  <section class="card" id="memberStatusCard">
    <h2>ขั้นที่ 1: ตรวจสอบการเข้าสู่ระบบสมาชิก</h2>
    <p class="sub">
      ต้องเป็นสมาชิกที่เข้าสู่ระบบผ่าน Firebase แล้ว และมีสถานะ <strong>approved</strong> จึงจะเข้าเรียนออนไลน์ได้
    </p>

    <div class="status-row">
      <div>
        สถานะปัจจุบัน:
        <span id="memberStatusText" class="badge badge-error">ยังไม่ได้ตรวจสอบ</span>
      </div>
      <div id="memberNameText"></div>
    </div>

    <div style="margin-top:8px; font-size:13px;">
      <button id="btnGoLogin" class="btn-main">ไปหน้าเข้าสู่ระบบ</button>
      <button id="btnRefreshMember" class="btn-ghost">รีเฟรชสถานะ</button>
    </div>

    <div id="memberMsg" class="msg"></div>
  </section>

  <!-- ชั้นที่ 2: รหัสเข้าสู่ระบบเรียนออนไลน์ -->
  <section class="card" id="secondLoginCard" style="display:none;">
    <h2>ขั้นที่ 2: รหัสเข้าสู่ระบบเรียนออนไลน์ (ชั้นที่ 2)</h2>
    <p class="sub">
      เพื่อความปลอดภัยของระบบเรียนออนไลน์ ให้กรอกรหัสเข้าใช้งานอีกชั้นหนึ่ง<br>
      (รหัสนี้สามารถเปลี่ยนภายหลังโดยผู้ดูแลระบบได้)
    </p>

    <div class="form-row">
      <div class="form-group">
        <label for="onlineCodeInput">รหัสเข้าเรียนออนไลน์</label>
        <input type="password" id="onlineCodeInput" placeholder="เช่น UBR-ONLINE-2025">
      </div>
      <div class="form-group" style="align-self:flex-end;">
        <button id="btnVerifyOnlineCode" class="btn-main">ยืนยันรหัสเข้าเรียนออนไลน์</button>
      </div>
    </div>

    <div id="secondLoginMsg" class="msg"></div>
  </section>

  <!-- พื้นที่เรียนออนไลน์ -->
  <section class="card" id="learningArea" style="display:none;">
    <h2>ระบบเรียนออนไลน์ | รายวิชาที่เปิดเรียน</h2>
    <p class="sub">
      แสดงรายวิชาที่คุณสามารถเข้าเรียนได้ พร้อมจำนวนชั่วโมงเรียน และสถานะความก้าวหน้า<br>
      สามารถ Export รายวิชาและชั่วโมงเรียนออกเป็นไฟล์ CSV (เปิดด้วย Excel) ได้
    </p>

    <div style="display:flex; flex-wrap:wrap; gap:8px; align-items:center; margin-bottom:6px;">
      <button id="btnExportCourses" class="btn-ghost">Export รายวิชาเป็น CSV</button>
      <span style="font-size:12px; color:#6b7280;">
        * ข้อมูลนี้เก็บในเบราว์เซอร์ เพื่อทดสอบการออกแบบระบบ
      </span>
    </div>

    <table id="coursesTable">
      <thead>
        <tr>
          <th>รหัสวิชา</th>
          <th>ชื่อวิชา</th>
          <th>ชั่วโมงทั้งหมด</th>
          <th>ชั่วโมงที่เรียนแล้ว</th>
          <th>ชั่วโมงคงเหลือ</th>
          <th>สถานะ</th>
        </tr>
      </thead>
      <tbody>
        <!-- เติมด้วย JS -->
      </tbody>
    </table>
  </section>

</main>

<footer>
  © 2025 โรงเรียนอุบลบุรีรักษ์การบริบาล | ระบบเรียนออนไลน์ 2 ชั้น (Firebase + Online Code)
</footer>

<!-- SCRIPT: Firebase + Double Login + Export -->
<script type="module">
  // ===== Firebase SDK =====
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
  import {
    getAuth,
    onAuthStateChanged
  } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";

  // ===== Firebase Config (ชุดเดียวกับ login.html) =====
  const firebaseConfig = {
    apiKey: "AIzaSyBhlCI3LfdCnOJzrTbK59nxL-77VyF9Mm0",
    authDomain: "urrschool-system.firebaseapp.com",
    projectId: "urrschool-system",
    storageBucket: "urrschool-system.firebasestorage.app",
    messagingSenderId: "183740550258",
    appId: "1:183740550258:web:674b73d1843553574fc6eb",
    measurementId: "G-GHLCDECTDF"
  };

  const app  = initializeApp(firebaseConfig);
  const auth = getAuth(app);

  console.log("✅ Firebase loaded on online-learning page");

  // ===== KEY ต่าง ๆ =====
  const CURRENT_USER_KEY    = "urr_current_user";          // จาก login.html
  const ONLINE_SESSION_KEY  = "urr_online_learning_ok";    // login ชั้นที่ 2
  const ONLINE_COURSES_KEY  = "urr_online_learning_courses";

  const ONLINE_CODE = "UBR-ONLINE-2025"; // ★★ เปลี่ยนรหัสที่นี่ได้ตามต้องการ ★★

  // ===== UTIL =====
  function loadJson(key, fallback) {
    try {
      const raw = localStorage.getItem(key);
      if (!raw) return fallback;
      return JSON.parse(raw);
    } catch {
      return fallback;
    }
  }

  function saveJson(key, value) {
    localStorage.setItem(key, JSON.stringify(value));
  }

  function getLocalProfile() {
    try {
      return JSON.parse(localStorage.getItem(CURRENT_USER_KEY) || "null");
    } catch {
      return null;
    }
  }

  function getSecondLoginFlag() {
    return sessionStorage.getItem(ONLINE_SESSION_KEY) === "true";
  }

  function setSecondLoginFlag(val) {
    if (val) {
      sessionStorage.setItem(ONLINE_SESSION_KEY, "true");
    } else {
      sessionStorage.removeItem(ONLINE_SESSION_KEY);
    }
  }

  // ===== อัปเดต UI ของขั้นที่ 1 =====
  function updateMemberStatusUI(profile, authUser) {
    const statusSpan = document.getElementById("memberStatusText");
    const nameSpan   = document.getElementById("memberNameText");
    const msgEl      = document.getElementById("memberMsg");

    if (!statusSpan || !nameSpan || !msgEl) return;

    if (!authUser) {
      statusSpan.textContent = "ยังไม่ได้เข้าสู่ระบบ Firebase";
      statusSpan.className = "badge badge-error";
      nameSpan.textContent = "";
      msgEl.textContent = "กรุณาเข้าสู่ระบบที่หน้า login.html ก่อน (ขั้นที่ 1)";
      msgEl.className = "msg error";

      // บล็อกขั้นที่ 2 และพื้นที่เรียนออนไลน์
      document.getElementById("secondLoginCard").style.display = "none";
      document.getElementById("learningArea").style.display    = "none";
      return;
    }

    if (!profile) {
      statusSpan.textContent = "ไม่พบข้อมูลโปรไฟล์ในเบราว์เซอร์";
      statusSpan.className = "badge badge-warn";
      nameSpan.textContent = authUser.email || "";
      msgEl.textContent =
        "ระบบพบว่าคุณล็อกอิน Firebase แล้ว แต่ไม่มี profile ใน localStorage (urr_current_user) กรุณาลองล็อกอินใหม่อีกครั้งที่หน้า login.html";
      msgEl.className = "msg error";

      document.getElementById("secondLoginCard").style.display = "none";
      document.getElementById("learningArea").style.display    = "none";
      return;
    }

    // มี profile แล้ว
    const fullName = (profile.firstName || "") + (profile.lastName ? " " + profile.lastName : "");
    nameSpan.textContent = `สมาชิก: ${fullName || profile.email || authUser.email || "ไม่ทราบชื่อ"} (role: ${profile.role || "user"})`;

    if (profile.status !== "approved") {
      statusSpan.textContent = "สถานะ: " + (profile.status || "unknown");
      statusSpan.className = "badge badge-error";
      msgEl.textContent =
        "บัญชีของคุณยังไม่ได้รับการอนุมัติ (approved) จากผู้ดูแล จึงยังเข้าเรียนออนไลน์ไม่ได้";
      msgEl.className = "msg error";

      document.getElementById("secondLoginCard").style.display = "none";
      document.getElementById("learningArea").style.display    = "none";
      return;
    }

    statusSpan.textContent = "เข้าสู่ระบบแล้ว (approved)";
    statusSpan.className = "badge badge-ok";
    msgEl.textContent = "ผ่านขั้นที่ 1 เรียบร้อย สามารถกรอกรหัสชั้นที่ 2 เพื่อเข้าเรียนออนไลน์ได้";
    msgEl.className = "msg success";

    // เปิดขั้นที่ 2
    document.getElementById("secondLoginCard").style.display = "block";

    // ถ้าเคยผ่านรหัสออนไลน์แล้ว ให้เปิดพื้นที่เรียนเลย
    if (getSecondLoginFlag()) {
      showLearningArea();
    }
  }

  // ===== ระบบชั้นที่ 2: รหัสเข้าเรียนออนไลน์ =====
  function setupSecondLogin() {
    const btn = document.getElementById("btnVerifyOnlineCode");
    const input = document.getElementById("onlineCodeInput");
    const msgEl = document.getElementById("secondLoginMsg");

    if (!btn || !input || !msgEl) return;

    btn.addEventListener("click", () => {
      const code = (input.value || "").trim();
      msgEl.textContent = "";
      msgEl.className = "msg";

      if (!code) {
        msgEl.textContent = "กรุณากรอกรหัสเข้าเรียนออนไลน์";
        msgEl.className = "msg error";
        return;
      }

      if (code !== ONLINE_CODE) {
        msgEl.textContent = "รหัสเข้าเรียนออนไลน์ไม่ถูกต้อง";
        msgEl.className = "msg error";
        return;
      }

      setSecondLoginFlag(true);
      msgEl.textContent = "ยืนยันรหัสถูกต้อง! เปิดระบบเรียนออนไลน์แล้ว";
      msgEl.className = "msg success";
      showLearningArea();
    });
  }

  function showLearningArea() {
    document.getElementById("learningArea").style.display = "block";
  }

  // ===== ระบบรายวิชา + Export CSV =====
  function initCoursesIfEmpty() {
    let courses = loadJson(ONLINE_COURSES_KEY, null);
    if (!courses || !Array.isArray(courses) || courses.length === 0) {
      courses = [
        {
          code: "NA101",
          name: "พื้นฐานการพยาบาลผู้ป่วยทั่วไป",
          totalHours: 30,
          learnedHours: 6
        },
        {
          code: "NA102",
          name: "การดูแลผู้สูงอายุและผู้ป่วยติดเตียง",
          totalHours: 40,
          learnedHours: 12
        },
        {
          code: "NA103",
          name: "ทักษะปฏิบัติในห้องพยาบาล (ออนไลน์เสริม)",
          totalHours: 20,
          learnedHours: 5
        }
      ];
      saveJson(ONLINE_COURSES_KEY, courses);
    }
    return courses;
  }

  function renderCourses() {
    const tbody = document.querySelector("#coursesTable tbody");
    if (!tbody) return;
    tbody.innerHTML = "";

    const courses = initCoursesIfEmpty();

    courses.forEach(c => {
      const remain = Math.max(0, (c.totalHours || 0) - (c.learnedHours || 0));
      const status =
        remain <= 0 ? "เรียนครบแล้ว" :
        c.learnedHours > 0 ? "กำลังเรียน" : "ยังไม่เริ่ม";

      const tr = document.createElement("tr");

      const tdCode   = document.createElement("td");
      const tdName   = document.createElement("td");
      const tdTotal  = document.createElement("td");
      const tdDone   = document.createElement("td");
      const tdRemain = document.createElement("td");
      const tdStatus = document.createElement("td");

      tdCode.textContent   = c.code || "-";
      tdName.textContent   = c.name || "-";
      tdTotal.textContent  = c.totalHours ?? "-";
      tdDone.textContent   = c.learnedHours ?? 0;
      tdRemain.textContent = remain;
      tdStatus.textContent = status;

      tr.appendChild(tdCode);
      tr.appendChild(tdName);
      tr.appendChild(tdTotal);
      tr.appendChild(tdDone);
      tr.appendChild(tdRemain);
      tr.appendChild(tdStatus);

      tbody.appendChild(tr);
    });
  }

  function exportCoursesCsv() {
    const courses = initCoursesIfEmpty();
    if (!courses || courses.length === 0) {
      alert("ยังไม่มีข้อมูลรายวิชาในระบบ");
      return;
    }

    const headers = [
      "code","name","totalHours","learnedHours","remainHours","status"
    ];
    const rows = [headers.join(",")];

    courses.forEach(c => {
      const remain = Math.max(0, (c.totalHours || 0) - (c.learnedHours || 0));
      const status =
        remain <= 0 ? "เรียนครบแล้ว" :
        c.learnedHours > 0 ? "กำลังเรียน" : "ยังไม่เริ่ม";

      const row = [
        c.code || "",
        c.name || "",
        c.totalHours ?? "",
        c.learnedHours ?? "",
        remain,
        status
      ].map(v => `"${String(v).replace(/"/g,'""')}"`);

      rows.push(row.join(","));
    });

    const csvContent = rows.join("\r\n");
    const blob = new Blob([csvContent], {type:"text/csv;charset=utf-8;"});
    const url = URL.createObjectURL(blob);

    const a = document.createElement("a");
    a.href = url;
    a.download = "online_learning_courses.csv";
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }

  // ===== DOM READY & Firebase Auth =====
  document.addEventListener("DOMContentLoaded", () => {
    // ปุ่มไปหน้า login
    document.getElementById("btnGoLogin").addEventListener("click", () => {
      window.location.href = "login.html";
    });

    // ปุ่มรีเฟรชสถานะ
    document.getElementById("btnRefreshMember").addEventListener("click", () => {
      const profile = getLocalProfile();
      const authUser = auth.currentUser;
      updateMemberStatusUI(profile, authUser);
    });

    // ปุ่ม Export
    const btnExport = document.getElementById("btnExportCourses");
    if (btnExport) {
      btnExport.addEventListener("click", exportCoursesCsv);
    }

    // ตั้งค่าระบบชั้นที่ 2
    setupSecondLogin();

    // render รายวิชา (เฉย ๆ ไว้ก่อน ส่วนการแสดง/ซ่อนดูที่ second login)
    renderCourses();
  });

  // ติดตามสถานะ Firebase Auth
  onAuthStateChanged(auth, (user) => {
    const profile = getLocalProfile();
    updateMemberStatusUI(profile, user);
  });
</script>

</body>
</html>
